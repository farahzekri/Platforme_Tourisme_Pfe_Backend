const Hotel = require('../Models/Hotel');
const Periode = require('../Models/PeriodeHotel');


const createPeriodeHotel = async (req, res) => {
    try {
     
        const { hotelId } = req.params;  
        const { dateDebut, dateFin, minNuits, allotement, delai_annulation, delai_retrocession, prixWeekday, prixWeekend, pourcentageSupplementSingle, pourcentageSupplementSingleWeekend, supplementsPrix, arrangementsPrix } = req.body;

       
        const newPeriode = new Periode({
            hotelId,
            dateDebut,
            dateFin,
            minNuits,
            allotement,
            delai_annulation,
            delai_retrocession,
            prixWeekday,
            prixWeekend,
            pourcentageSupplementSingle,
            pourcentageSupplementSingle,
            supplementsPrix,
            arrangementsPrix
        });
        await newPeriode.save();
        await Hotel.findByIdAndUpdate(hotelId, { $push: { periodes: newPeriode._id } ,status: "active" });

      
        return res.status(201).json({ success: true, message: "P√©riode ajout√©e avec succ√®s", periode: newPeriode });

    } catch (error) {
        console.error("Erreur lors de l'ajout de la p√©riode :", error);
        return res.status(500).json({ success: false, message: "Erreur lors de l'ajout de la p√©riode" });
    }
};
const calculerPrixTotal = (adultes, enfants, agesEnfants, prixBase, prixArrangement, prixSupplements, periode, typeContract, minChildAge, maxChildAge) => {
    let prixTotal = 2 * (prixBase + prixSupplements + prixArrangement);

    // Suppl√©ment pour les adultes suppl√©mentaires
    if (adultes > 2) {
        let supplementSingle = periode.pourcentageSupplementSingle / 100 || 0;
        prixTotal += (prixBase + prixSupplements + prixArrangement) * (adultes - 2) * (1 - supplementSingle);
    }

    // Gestion des enfants si le type de contrat est "R√©duction par √¢ge d'enfant"
    if (typeContract === "R√©duction par √¢ge d'enfant" && enfants > 0) {
        for (let age of agesEnfants) {
            if (age < 2) {
                // Enfant de moins de 2 ans ‚Üí Gratuit
                continue;
            } else if (age >= minChildAge && age <= maxChildAge) {
                // Enfant entre minChildAge et maxChildAge ‚Üí R√©duction de 50%
                prixTotal += (prixBase + prixSupplements + prixArrangement) * 0.5;
            } else {
                // Enfant plus √¢g√© que maxChildAge ‚Üí Paie comme un adulte
                prixTotal += prixBase + prixSupplements + prixArrangement;
            }
        }
    }

    return prixTotal;
};
const searchHotels = async (req, res) => {
    try {
        const { country, dateDebut, dateFin, adultes, enfants, agesEnfants, arrangementChoisi, supplementsChoisis } = req.body;

        let hotels = await Hotel.find({ country, status: "active" }).populate("periodes");

        let resultats = [];

        for (let hotel of hotels) {
            let periodesDisponibles = hotel.periodes.filter(periode => 
                new Date(periode.dateDebut) <= new Date(dateDebut) &&
                new Date(periode.dateFin) >= new Date(dateFin)
            );

            if (periodesDisponibles.length === 0) continue;

            let periode = periodesDisponibles[0]; 

            let joursWeekend = hotel.Jourdeweekend || [];
            let estWeekend = joursWeekend.some(jour => 
                [new Date(dateDebut).getDay(), new Date(dateFin).getDay()].includes(jour)
            );

            let prixBase = estWeekend ? periode.prixWeekend : periode.prixWeekday;

            let prixArrangement = periode.arrangementsPrix.find(arr => arr.arrangement === arrangementChoisi)?.prix ||
                                  periode.arrangementsPrix.find(arr => arr.arrangement === "petit d√©jeuner")?.prix || 0;

            let prixSupplements = 0;
            if (supplementsChoisis.length > 0) {
                for (let supp of supplementsChoisis) {
                    let suppObj = periode.supplementsPrix.find(s => s.supplement === supp);
                    if (suppObj) prixSupplements += suppObj.prix;
                }
            }

            // R√©cup√©rer les informations du contrat pour les r√©ductions enfants
            let typeContract = hotel.Typecontract || ""; 
            let minChildAge = hotel.minChildAge || 0;
            let maxChildAge = hotel.maxChildAge || 0;

            // üîπ Appel de `calculerPrixTotal` avec gestion des enfants
            let prixTotal = calculerPrixTotal(adultes, enfants, agesEnfants, prixBase, prixArrangement, prixSupplements, periode, typeContract, minChildAge, maxChildAge);

            resultats.push({
                hotel: hotel.name,
                country: hotel.country,
                city: hotel.city,
                stars:hotel.stars,
                prixTotal,
                image: hotel.image[0],
                arrangement: arrangementChoisi || "petit d√©jeuner"
            });
        }

        return res.status(200).json({ success: true, hotels: resultats });

    } catch (error) {
        console.error("Erreur lors de la recherche d'h√¥tels :", error);
        return res.status(500).json({ success: false, message: "Erreur lors de la recherche d'h√¥tels" });
    }
};
const getAllPeriodeByHotelid=async(req,res)=>{
    try{
        const { hotelId } = req.params;
        const periodes = await Periode.find({ hotelId }); 
        res.status(200).json(periodes);
    }catch (error) {
        console.error("Erreur lors de la r√©cup√©ration des p√©riodes :", error);
        res.status(500).json({ message: "Erreur serveur" });
}};

const getHotelsetprixmin = async (req, res) => {
    try {
        // Date actuelle
        const today = new Date();
        console.log("Date d'aujourd'hui :", today);

        // R√©cup√©rer les h√¥tels actifs
        const hotels = await Hotel.find({ status: "active" });

        // V√©rifier si des h√¥tels sont trouv√©s
        if (!hotels.length) {
            return res.json({ message: "Aucun h√¥tel actif trouv√©" });
        }

        // Parcourir chaque h√¥tel et chercher la p√©riode active
        const hotelsWithPrice = await Promise.all(
            hotels.map(async (hotel) => {
                console.log(`Recherche de p√©riode pour l'h√¥tel : ${hotel.name}`);

                // Trouver la p√©riode active
                const periode = await Periode.findOne({
                    hotelId: hotel._id,
                    dateDebut: { $lte: today },
                    dateFin: { $gte: today },
                });

                if (!periode) {
                    console.log(`‚ùå Aucune p√©riode trouv√©e pour l'h√¥tel : ${hotel.name}`);
                    return null;
                }

                // R√©cup√©rer le prix de l'arrangement "petit d√©jeuner"
                const petitDej = periode.arrangementsPrix.find(arr => arr.arrangement === "petit d√©jeuner");
                const prixPetitDej = petitDej ? petitDej.prix : 0;

                console.log(`‚úÖ P√©riode trouv√©e pour ${hotel.name} - Prix weekday: ${periode.prixWeekday}, weekend: ${periode.prixWeekend}`);

                // Retourner les informations format√©es
                return {
                    id:hotel.id,
                    name: hotel.name,
                    stars: hotel.stars,
                    country: hotel.country,
                    city: hotel.city,
                    arrangement:hotel.arrangement,
                    supplements:hotel.supplements,
                    image:hotel.image,
                    prixMinWeekday: periode.prixWeekday + prixPetitDej,
                    prixMinWeekend: periode.prixWeekend + prixPetitDej,
                };
            })
        );

        // Filtrer les h√¥tels qui n'ont pas de p√©riode
        const filteredHotels = hotelsWithPrice.filter(h => h !== null);

        if (!filteredHotels.length) {
            return res.json({ message: "Aucun h√¥tel avec une p√©riode active trouv√©e" });
        }

        res.json(filteredHotels);
    } catch (error) {
        console.error("Erreur lors de la r√©cup√©ration des h√¥tels :", error);
        res.status(500).json({ error: "Erreur interne du serveur" });
    }
};
const getHotelDetails = async (req, res) => {
    try {
        const { id } = req.params;
        const today = new Date();

        // R√©cup√©rer l'h√¥tel
        const hotel = await Hotel.findById(id);
        if (!hotel) {
            return res.status(404).json({ message: "H√¥tel non trouv√©" });
        }

        // Trouver la p√©riode active pour cet h√¥tel
        const periode = await Periode.findOne({
            hotelId: hotel._id,
            dateDebut: { $lte: today },
            dateFin: { $gte: today },
        });

        if (!periode) {
            return res.json({ message: "Aucune p√©riode active trouv√©e pour cet h√¥tel" });
        }

        // R√©cup√©rer le prix de l'arrangement "petit d√©jeuner"
        const petitDej = periode.arrangementsPrix.find(arr => arr.arrangement === "petit d√©jeuner");
        const prixPetitDej = petitDej ? petitDej.prix : 0;

        // Multiplier les prix par 2 (chambre double)
        const prixMinWeekday = (periode.prixWeekday + prixPetitDej) * 2;
        const prixMinWeekend = (periode.prixWeekend + prixPetitDej) * 2;

        // Construire la r√©ponse avec tous les d√©tails de l'h√¥tel
        const hotelDetails = {
            id:hotel.id,
            name: hotel.name,
            stars: hotel.stars,
            country: hotel.country,
            delai_annulation:periode.delai_annulation,
            address:hotel.address,
            city: hotel.city,
            arrangement: hotel.arrangement,
            supplements: hotel.supplements,
            images: hotel.image,
            prixMinWeekday,
            prixMinWeekend,
        };

        res.json(hotelDetails);
    } catch (error) {
        console.error("Erreur lors de la r√©cup√©ration des d√©tails de l'h√¥tel :", error);
        res.status(500).json({ error: "Erreur interne du serveur" });
    }
};
const updateperiode =async(req,res)=>{
    try{
       const {id}=req.params;
       const updateData=req.body;
       const updatPriode=await Periode.findByIdAndUpdate(id,updateData,{new:true});
       if (!updatPriode){
        return res.status(404).json({ message: "Periode non trouv√©." });
       }
       res.status(200).json({ message: "Periode mis √† jour avec succ√®s.", periode: updatPriode });
    }catch(error){
        console.error(error);
        res.status(500).json({ message: "Erreur lors de la mise √† jour de Periode." });
    }
}
const getperiodebyidperiode=async(req,res)=>{
    try{
        const {id}=req.params;
        const periode= await Periode.findById(id);
        res.status(200).json(periode);
    }catch(error){
        res.status(500).json({ message: "Erreur lors de la r√©cup√©ration." });
    }
};
const deletePeriode = async (req, res) => {
    try {
        const { id } = req.params;

     
        const periode = await Periode.findById(id);
        if (!periode) {
            return res.status(404).json({ message: "P√©riode non trouv√©e." });
        }

       
        const hotelId = periode.hotelId;
        const hotel = await Hotel.findById(hotelId);
        if (!hotel) {
            return res.status(404).json({ message: "H√¥tel non trouv√©." });
        }

        await Hotel.findByIdAndUpdate(hotelId, { $pull: { periodes: id } });

        await Periode.findByIdAndDelete(id);

        res.status(200).json({ message: "P√©riode supprim√©e avec succ√®s." });
    } catch (error) {
        console.error(error);
        res.status(500).json({ message: "Erreur lors de la suppression de la p√©riode." });
    }
};
module.exports={
    createPeriodeHotel,
    searchHotels,
    getAllPeriodeByHotelid,
    getHotelsetprixmin,
    updateperiode,
    getperiodebyidperiode,
    deletePeriode,
    getHotelDetails,
}